# ShanoirNgBoutiques

Boutiques microservice serving the Boutiques API.

## Docker container & data management

Host:

  - volume: /tmp  (contains: `boutiques/input/` for the input files, and `boutiques/output/` for the launch script (see below) and the output files)

  Datasets microservice:

    - volume: /tmp:/tmp
    - notes:
       - will prepare the input files for the Boutiques microservice in a `/tmp/boutiques/input/random_number` directory

  Boutiques microservice:

    - volumes: 
       - /tmp:/tmp
       - /var/run/docker.sock:/var/run/docker.sock
    - notes:
       - will look for input files in the `/tmp/boutiques/input/random_number` directory with the given `random_number` (given by the frontend)
       - the docker socket of this container is bound to the docker socket of the host so that the docker commands in this container are redirected to the docker server of the host (thus executed on the host)
       - in this way, bosh (the boutiques command line interface) will spawn a sibling container "Boutiques tool" when executing a boutiques tool (instead of creating a *subcontainer* in the "Boutiques microservice" container)
       - bosh will create a script file (named `random_numbers.localExec.boshjob.sh` in `/tmp/boutiques/output/`) containing the command to launch the tool
       - the container "Boutiques tool" spawned by bosh will need this script file, so it need to access the same `/tmp/boutiques/output/` directory

  Boutiques tool (spawned by the boutiques microservice):

    - volume: /tmp:/tmp
    - notes:
       - will look for the `random_numbers.localExec.boshjob.sh` scritp in `/tmp/boutiques/output/` to execute the boutiques tool


This architecture forces that all containers share the same `/tmp` volume which correspond to the `/tmp` directory on the host.

The `tmp/` directory is used by other microservices and might be difficult to share among distributed servers (if the different microservices run on different servers).
An alternative would be to share a specific volumes `/boutiques/` (also bound to `/boutiques/` on the host) among the Datasets microservice, Boutiques microservice and the Boutiques tool.
Again, the volumes must have the same name as the directory on the host because, in the boutiques microservice, bosh creates the launch script which must be used by the spawned Boutiques tool container (spawned on the host, so its volumes are bounds to the host ; not related to the boutiques microservice directory where the launch script was created, unless the directory name is the same in the boutiques microservice container and on the host).

## Workflow

The boutique frontend enable the user to choose a boutique tool, set its parameters and execute it on the backend.
A boutiques tool can have differents input of the following types: string, files, numbers, booleans (flags), or list (of those types).
For file inputs, the frontend enable to select a file from a dataset.

The process of setting files as input for a boutiques tool works as followed:

 - on the frontend, for each file input, the user can select one dataset (among all datasets),
 - with the selected dataset, the frontend asks the Datasets microservice (on the backend) to list its files,
 - the user can then select a specific file in this list on the frontend,
 - once selected, the front will tell the Datasets microservice to download and store the file to a directory (in `/tmp/boutiques/input/random_number/`), 
 - the Datasets microservice will respond to the frontend with the random number of the created path (`random_number`),
 - when the user launches the execution of the tool, the front will send the paths generated by the Datasets microservice so that the boutiques microservice find and use them
 - the boutiques microservice calls bosh (the boutiques command line interface) which spawn a container (on the host) to execute the tool
 - the spawned container has a `tmp` volume bound to `tmp/` on the host, the output files are created in the `/tmp/boutiques/output/toolId + sessionId + userId` (the output directory depends on the tool id, the user and the session; thus the same user can launch multiple processed at the same time (with different sessions = from different browser tabs) )
 - when the user requests to download the output files, the boutiques microservice zips and sends the `/tmp/boutiques/output/toolId + sessionId + userId` directory